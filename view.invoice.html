<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Facture Become — Consultation</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <style>
    :root {
      --bg: #F4F1EC;
      --surface: #FFFFFF;
      --text: #1A1A1A;
      --muted: #6B6B6B;
      --accent: #8B6F47;
      --border: #E2DDD5;
    }

    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg);
      color: var(--text);
      padding: 20px;
    }

    /* ZONE FACTURE (Ce qui sera dans le PDF) */
    #invoice {
      background: var(--surface);
      max-width: 500px;
      margin: 0 auto;
      padding: 40px 30px;
      border-radius: 8px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.05);
    }

    .brand { text-align: center; margin-bottom: 30px; }
    .brand h1 { margin: 0; font-size: 24px; letter-spacing: 4px; text-transform: uppercase; }
    
    .inv-header { display: flex; justify-content: space-between; margin-bottom: 40px; font-size: 13px; }
    .inv-details h2 { font-size: 14px; text-transform: uppercase; margin-bottom: 5px; }
    
    table { width: 100%; border-collapse: collapse; margin-bottom: 30px; }
    th { text-align: left; font-size: 11px; text-transform: uppercase; color: var(--muted); padding-bottom: 10px; border-bottom: 1px solid var(--border); }
    td { padding: 12px 0; border-bottom: 1px solid #F9F9F9; font-size: 14px; }

    .total-zone { text-align: right; margin-top: 20px; }
    .total-row { display: flex; justify-content: flex-end; gap: 20px; margin-bottom: 5px; }
    .total-amount { font-size: 20px; font-weight: 800; color: var(--accent); }

    /* BOUTONS (Masqués lors de l'impression) */
    .actions {
      max-width: 500px;
      margin: 25px auto;
      display: grid;
      grid-template-columns: 1fr 2fr;
      gap: 15px;
    }

    button {
      height: 50px;
      border-radius: 12px;
      border: none;
      font-weight: 700;
      cursor: pointer;
      font-size: 14px;
      transition: 0.2s;
    }

    .back-btn { background: #E2DDD5; color: var(--text); }
    .download-btn { background: var(--accent); color: white; display: flex; align-items: center; justify-content: center; gap: 10px; }
    button:active { transform: scale(0.96); }

    @media print { .actions { display: none; } }
  </style>
</head>
<body>

  <div id="invoice">
    <div class="brand">
      <h1>BECOME</h1>
      <p style="font-size: 10px; color: var(--muted); margin-top: 5px;">Luxury & Elegance Boutique</p>
    </div>

    <div class="inv-header">
      <div class="inv-details">
        <h2>Facture à</h2>
        <p id="custName">Chargement...</p>
        <p id="custPhone" style="color: var(--muted);"></p>
      </div>
      <div style="text-align: right;">
        <p><b id="invNum">#---</b></p>
        <p id="invDate" style="color: var(--muted);"></p>
      </div>
    </div>

    <table>
      <thead>
        <tr>
          <th>Article</th>
          <th style="text-align: center;">Qté</th>
          <th style="text-align: right;">Prix</th>
        </tr>
      </thead>
      <tbody id="itemsList">
        </tbody>
    </table>

    <div class="total-zone">
      <div class="total-row">
        <span style="color: var(--muted);">Sous-total :</span>
        <span id="subTotal">0.00 $</span>
      </div>
      <div class="total-row">
        <span style="font-weight: 700;">TOTAL RÉGLÉ :</span>
        <span class="total-amount" id="finalTotal">0.00 $</span>
      </div>
    </div>
  </div>

  <div class="actions">
    <button class="back-btn" onclick="history.back()">Retour</button>
    <button class="download-btn" id="pdfBtn">
      <i class="fa-solid fa-file-pdf"></i> TÉLÉCHARGER PDF
    </button>
  </div>

  <script type="module">
    import { db } from "./js/firebase.config.js";
    import { doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const urlParams = new URLSearchParams(window.location.search);
    const orderId = urlParams.get('orderId');

    async function loadInvoice() {
      if (!orderId) return;

      const docRef = doc(db, "orders", orderId);
      const snap = await getDoc(docRef);

      if (snap.exists()) {
        const o = snap.data();
        
        document.getElementById("custName").textContent = o.customerName || "Client";
        document.getElementById("custPhone").textContent = o.customerPhone || "";
        document.getElementById("invNum").textContent = `#${o.orderNumber || orderId.substring(0,6).toUpperCase()}`;
        document.getElementById("invDate").textContent = o.createdAt?.toDate().toLocaleDateString('fr-FR');
        
        const list = document.getElementById("itemsList");
        list.innerHTML = "";
        o.items.forEach(item => {
          list.innerHTML += `
            <tr>
              <td>${item.name}</td>
              <td style="text-align: center;">${item.quantity || 1}</td>
              <td style="text-align: right;">${item.price.toLocaleString()} $</td>
            </tr>
          `;
        });

        const total = o.totalAmount || o.total || 0;
        document.getElementById("subTotal").textContent = total.toLocaleString() + " $";
        document.getElementById("finalTotal").textContent = total.toLocaleString() + " $";
      }
    }

    loadInvoice();

    // LOGIQUE DE TÉLÉCHARGEMENT
    document.getElementById("pdfBtn").onclick = () => {
      const element = document.getElementById("invoice");
      const opt = {
        margin: 10,
        filename: `Facture_Become_${orderId.substring(0,6)}.pdf`,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 3, useCORS: true },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
      };
      html2pdf().set(opt).from(element).save();
    };
  </script>
</body>
</html>
