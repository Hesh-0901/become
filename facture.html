<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Facture â€” Become</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
  <meta name="theme-color" content="#7A623F">

  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <!-- PDF LIB (OBLIGATOIRE POUR MOBILE) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <style>
    :root{
      --bg:#E9E5DF;
      --surface:#FFF;
      --text:#1E1E1E;
      --muted:#6B6B6B;
      --accent:#8B6F47;
      --border:#D6CFC4;
    }

    body{
      margin:0;
      font-family:system-ui;
      background:var(--bg);
      color:var(--text);
    }

    header{
      padding:14px;
      text-align:center;
      font-weight:600;
      letter-spacing:2px;
    }

    /* ===== FACTURE ===== */
    #invoice{
      background:#fff;
      max-width:800px;
      margin:14px auto;
      padding:20px;
      border-radius:14px;
      border:1px solid var(--border);
    }

    .top{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:20px;
    }

    .logo img{
      height:40px;
    }

    .invoice-title{
      text-align:right;
    }

    .invoice-title h2{
      margin:0;
      font-size:18px;
      letter-spacing:2px;
    }

    .invoice-title span{
      font-size:12px;
      color:var(--muted);
    }

    hr{
      border:none;
      border-top:1px solid var(--border);
      margin:14px 0;
    }

    .info{
      font-size:13px;
      margin-bottom:16px;
    }

    .info div{
      margin-bottom:4px;
    }

    table{
      width:100%;
      border-collapse:collapse;
      font-size:13px;
    }

    th, td{
      text-align:left;
      padding:8px 4px;
      border-bottom:1px solid var(--border);
    }

    th{
      font-size:12px;
      text-transform:uppercase;
      color:var(--muted);
    }

    .total{
      text-align:right;
      font-size:16px;
      font-weight:600;
      margin-top:14px;
    }

    .status{
      margin-top:18px;
      padding:12px;
      background:#F7F5F2;
      border-radius:10px;
      font-size:13px;
    }

    .footer-note{
      margin-top:20px;
      font-size:12px;
      color:var(--muted);
      text-align:center;
    }

    /* ===== ACTIONS ===== */
    .actions{
      max-width:800px;
      margin:0 auto 20px;
      padding:14px;
      display:flex;
      gap:10px;
    }

    .btn{
      flex:1;
      height:46px;
      border-radius:999px;
      border:none;
      font-weight:600;
      cursor:pointer;
    }

    .primary{
      background:var(--accent);
      color:#fff;
    }

    .secondary{
      background:#fff;
      border:1px solid var(--border);
    }
  </style>
</head>

<body>

<header>FACTURE</header>

<!-- ================= FACTURE ================= -->
<div id="invoice">

  <div class="top">
    <div class="logo">
      <img src="icons/logo/logo.png" alt="Become">
    </div>

    <div class="invoice-title">
      <h2>BECOME</h2>
      <span id="orderNumber">â€”</span>
    </div>
  </div>

  <hr>

  <div class="info">
    <div><strong>Date :</strong> <span id="date"></span></div>
    <div><strong>Client :</strong> <span id="clientName"></span></div>
    <div><strong>TÃ©lÃ©phone :</strong> <span id="clientPhone"></span></div>
    <div><strong>Adresse :</strong> <span id="clientAddress"></span></div>
  </div>

  <table>
    <thead>
      <tr>
        <th>Article</th>
        <th>QtÃ©</th>
        <th>Prix</th>
      </tr>
    </thead>
    <tbody id="items"></tbody>
  </table>

  <div class="total" id="total"></div>

  <div class="status">
    ðŸ’¬ Paiement manuel â€” veuillez nous contacter pour finaliser le paiement.<br>
    ðŸ“¦ Suivez lâ€™Ã©volution de votre commande dans lâ€™application.
  </div>

  <div class="footer-note">
    Merci pour votre confiance â€” Become
  </div>

</div>

<!-- ================= ACTIONS ================= -->
<div class="actions">
  <button class="btn secondary" onclick="location.href='index.html'">
    Retour boutique
  </button>
  <button class="btn primary" id="pdfBtn">
    TÃ©lÃ©charger PDF
  </button>
</div>

<script type="module">
import { db } from "./js/firebase.config.js";
import { doc, getDoc } from
  "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

/* ===== PARAM ===== */
const params = new URLSearchParams(location.search);
const orderId = params.get("orderId");

if(!orderId){
  location.href="index.html";
}

/* ===== LOAD ORDER ===== */
const ref = doc(db,"orders",orderId);
const snap = await getDoc(ref);

if(!snap.exists()){
  alert("Facture introuvable");
  location.href="index.html";
}

const o = snap.data();

/* ===== FILL ===== */
document.getElementById("orderNumber").textContent = o.orderNumber;

document.getElementById("date").textContent =
  new Date().toLocaleString("fr-FR");

document.getElementById("clientName").textContent = o.customer.name;
document.getElementById("clientPhone").textContent = o.customer.phone;
document.getElementById("clientAddress").textContent =
  o.customer.address || "-";

const itemsEl = document.getElementById("items");
let total = 0;

o.items.forEach(p=>{
  total += p.price * p.qty;
  itemsEl.innerHTML += `
    <tr>
      <td>${p.title}</td>
      <td>${p.qty}</td>
      <td>${(p.price*p.qty).toLocaleString()} CDF</td>
    </tr>
  `;
});

document.getElementById("total").textContent =
  `Total : ${total.toLocaleString()} CDF`;

/* ===== PDF ===== */
document.getElementById("pdfBtn").onclick = ()=>{
  const el = document.getElementById("invoice");

  html2pdf().set({
    margin:0.4,
    filename:`FACTURE-${o.orderNumber}.pdf`,
    image:{ type:"jpeg", quality:0.98 },
    html2canvas:{ scale:2, useCORS:true },
    jsPDF:{ unit:"cm", format:"a4", orientation:"portrait" }
  }).from(el).save();
};
</script>

</body>
</html>