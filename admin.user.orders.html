<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Become Admin — Historique</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    :root {
      --bg: #F4F1EC;        /* Sable Become */
      --surface: #FFFFFF;
      --text: #252525;      /* Anthracite au lieu du noir pur */
      --muted: #9A9A9A;
      --accent: #8B6F47;    /* Doré Become */
      --border: #E2DDD5;
    }

    body {
      margin: 0;
      background: var(--bg);
      font-family: 'Inter', -apple-system, sans-serif;
      padding: 0;
      color: var(--text);
      -webkit-font-smoothing: antialiased;
    }

    /* HEADER MINIMALISTE */
    .top-nav {
      position: sticky;
      top: 0;
      background: rgba(244, 241, 236, 0.9);
      backdrop-filter: blur(10px);
      padding: 30px 20px 15px;
      z-index: 10;
      border-bottom: 0.5px solid var(--border);
    }

    .nav-content {
      max-width: 600px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
    }

    h1 {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 3px;
      font-weight: 800;
      margin: 0 0 5px 0;
    }

    #userNameDisplay {
      font-size: 18px;
      font-weight: 400;
      color: var(--accent);
      display: block;
    }

    .back-link { color: var(--text); font-size: 18px; text-decoration: none; }

    /* STATS ÉPURÉES */
    .stats-grid {
      max-width: 600px;
      margin: 20px auto;
      display: grid;
      grid-template-columns: 1fr 1fr;
      padding: 0 20px;
      gap: 1px;
      background: var(--border); /* Crée une ligne séparatrice fine */
    }

    .stat-box {
      background: var(--bg);
      padding: 15px 0;
    }

    .stat-label {
      display: block;
      font-size: 8px;
      text-transform: uppercase;
      letter-spacing: 1.5px;
      color: var(--muted);
      margin-bottom: 4px;
    }

    .stat-val { font-size: 16px; font-weight: 600; }

    /* LISTE DES COMMANDES - STYLE SOBRE */
    #ordersList { max-width: 600px; margin: 0 auto; padding: 0 20px 100px; }

    .order-entry {
      padding: 25px 0;
      border-bottom: 0.5px solid var(--border);
    }

    .order-meta {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 15px;
    }

    .order-id { font-size: 11px; font-weight: 700; color: var(--muted); }
    
    .status-badge {
      font-size: 8px;
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--accent);
    }

    .items-list {
      margin: 10px 0;
      padding: 0;
      list-style: none;
    }

    .item-row {
      display: flex;
      justify-content: space-between;
      font-size: 13px;
      margin-bottom: 6px;
      color: #555;
    }

    .order-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 15px;
    }

    .order-date { font-size: 10px; color: var(--muted); text-transform: uppercase; }
    .order-price { font-size: 15px; font-weight: 700; color: var(--text); }

    .empty-msg { text-align: center; padding: 100px 0; color: var(--muted); font-size: 12px; letter-spacing: 1px; }
  </style>
</head>
<body>

  <div class="top-nav">
    <div class="nav-content">
      <div>
        <h1>Historique</h1>
        <span id="userNameDisplay">...</span>
      </div>
      <a href="view.user.html" class="back-link"><i class="fa-solid fa-xmark"></i></a>
    </div>
  </div>

  <div class="stats-grid">
    <div class="stat-box">
      <span class="stat-label">Volume</span>
      <span class="stat-val" id="orderCount">0</span>
    </div>
    <div class="stat-box" style="text-align: right;">
      <span class="stat-label">Valeur Client</span>
      <span class="stat-val" id="totalSpent">0.00 USD</span>
    </div>
  </div>

  <div id="ordersList">
    <div class="empty-msg">Recherche des archives...</div>
  </div>

  <script type="module">
    import { db } from "./js/firebase.config.js";
    import { collection, query, where, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const params = new URLSearchParams(window.location.search);
    const userId = params.get("uid");
    const userName = params.get("name");

    if (!userId) window.location.href = "view.user.html";

    document.getElementById("userNameDisplay").textContent = decodeURIComponent(userName || "Client");

    // Collection "orders" - Triée par date décroissante
    const q = query(collection(db, "orders"), where("userId", "==", userId), orderBy("createdAt", "desc"));

    onSnapshot(q, (snap) => {
      const list = document.getElementById("ordersList");
      const countEl = document.getElementById("orderCount");
      const spentEl = document.getElementById("totalSpent");
      
      list.innerHTML = "";
      let totalValue = 0;
      countEl.textContent = snap.size;

      if (snap.empty) {
        list.innerHTML = '<div class="empty-msg">AUCUNE COMMANDE TROUVÉE.</div>';
        spentEl.textContent = "0.00 USD";
        return;
      }

      snap.forEach(doc => {
        const o = doc.data();
        // Utilisation de totalAmount (harmonisé avec ta page commande)
        const amount = o.totalAmount || o.total || 0; 
        totalValue += amount;

        const date = o.createdAt?.toDate().toLocaleDateString('en-US', { day: '2-digit', month: 'short', year: 'numeric' });
        
        const entry = document.createElement("div");
        entry.className = "order-entry";
        entry.innerHTML = `
          <div class="order-meta">
            <span class="order-id">#${o.orderNumber || doc.id.substring(0, 8).toUpperCase()}</span>
            <span class="status-badge">${o.status || 'En attente'}</span>
          </div>
          
          <div class="items-list">
            ${(o.items || []).map(item => `
              <div class="item-row">
                <span>${item.qty || item.quantity}× ${item.title || item.name}</span>
                <span>${((item.price || 0) * (item.qty || item.quantity || 1)).toLocaleString('en-US', {minimumFractionDigits: 2})}</span>
              </div>
            `).join('')}
          </div>

          <div class="order-footer">
            <span class="order-date">${date}</span>
            <span class="order-price">${amount.toLocaleString('en-US', {minimumFractionDigits: 2})} USD</span>
          </div>
        `;
        list.appendChild(entry);
      });

      spentEl.textContent = totalValue.toLocaleString('en-US', {minimumFractionDigits: 2}) + " USD";
    });
  </script>
</body>
</html>
