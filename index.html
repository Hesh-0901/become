<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Become boutique</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#7A623F"> 
  <link rel="manifest" href="manifest.json">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <style>
    :root {
      --bg:#F4F1EC;
      --surface:#FFFFFF;
      --surface-soft:#EBE7E0;
      --text:#252525;
      --muted:#8E8E8E;
      --accent:#8B6F47;
      --border:#E2DDD5;
      --radius:12px;
    }

    *{box-sizing:border-box; -webkit-tap-highlight-color:transparent;}

    body{
      margin:0;
      font-family:'Inter', -apple-system, system-ui, sans-serif;
      background:var(--bg);
      color:var(--text);
      padding-bottom:80px;
    }

    header {
      position: sticky;
      top: 0;
      background: rgba(244, 241, 236, 0.85);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border-bottom: 0.5px solid var(--border);
      z-index: 100;
    }

    .bar {
      height: 60px;
      padding: 0 18px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      max-width: 1200px;
      margin: 0 auto;
    }

    /* Ajustement de la taille pour que le logo "Become" soit bien visible */
    .brand img { height: 24px; width: auto; border-radius: 4px; }

    .actions {
      display: flex;
      align-items: center;
      gap: 18px;
    }

    .actions i {
      color: var(--text);
      cursor: pointer;
      font-size: 16px;
      transition: opacity 0.2s;
    }

    #userGreeting {
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--accent);
      cursor: pointer;
    }

    .cart-wrapper { position: relative; }
    .cart-count {
      position: absolute;
      top: -8px;
      right: -10px;
      background: var(--text);
      color: #fff;
      font-size: 9px;
      font-weight: 800;
      padding: 2px 5px;
      border-radius: 6px;
      min-width: 16px;
      text-align: center;
    }

    .grid {
      padding: 18px;
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 18px;
    }

    @media(min-width:768px){ .grid { grid-template-columns: repeat(4, 1fr); margin: auto; } }

    .card {
      background: var(--surface);
      border-radius: var(--radius);
      overflow: hidden;
      border: 0.5px solid var(--border);
      transition: transform 0.2s ease;
    }

    .card img {
      width: 100%;
      aspect-ratio: 1/1.2;
      object-fit: cover;
      display: block;
      background: #eee;
    }

    .card-body { padding: 12px; }

    .title {
      font-size: 12px;
      font-weight: 500;
      margin: 0;
      color: var(--text);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .price {
      margin-top: 5px;
      font-size: 13px;
      font-weight: 700;
      color: var(--accent);
    }

    .toast {
      position: fixed;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--text);
      color: white;
      padding: 10px 20px;
      border-radius: 99px;
      font-size: 12px;
      font-weight: 500;
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.3s;
      pointer-events: none;
    }

    .pagination {
      position: fixed;
      bottom: 0; left: 0; right: 0;
      height: 65px;
      background: rgba(244, 241, 236, 0.9);
      backdrop-filter: blur(10px);
      border-top: 0.5px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 25px;
      z-index: 90;
    }

    .pagination button {
      border: 0.5px solid var(--border);
      background: var(--surface);
      padding: 8px 20px;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
    }

    .pagination span { font-size: 11px; font-weight: 600; color: var(--muted); text-transform: uppercase; letter-spacing: 1px; }

    /* Bulle iOS */
    .ios-prompt {
      position: fixed; bottom: 85px; left: 50%; transform: translateX(-50%);
      width: 90%; max-width: 350px; background: white; color: #252525;
      padding: 15px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.15);
      z-index: 999; display: none; font-size: 13px; border: 1px solid var(--border);
    }
    .ios-prompt::after {
      content: ''; position: absolute; bottom: -10px; left: 50%;
      transform: translateX(-50%); border-left: 10px solid transparent;
      border-right: 10px solid transparent; border-top: 10px solid white;
    }
  </style>
</head>

<body>

<header>
  <div class="bar">
    <div class="brand">
      <img src="icons/logo/logo.png" alt="Become" onclick="location.reload()" style="cursor:pointer">
    </div>
    <div class="actions">
      <i id="searchBtn" class="fa-solid fa-magnifying-glass"></i>
      <div class="cart-wrapper">
        <i id="cartBtn" class="fa-solid fa-bag-shopping"></i>
        <span id="cartCount" class="cart-count" style="display:none">0</span>
      </div>
      <span id="userGreeting" onclick="location.href='user.html'">Log in</span>
      <i id="installBtn" class="fa-solid fa-arrow-down-short-wide" style="display:none"></i>
    </div>
  </div>
</header>

<main class="grid" id="grid"></main>

<div class="pagination">
  <button id="prev"><i class="fa-solid fa-chevron-left"></i></button>
  <span id="pageInfo">01 / 01</span>
  <button id="next"><i class="fa-solid fa-chevron-right"></i></button>
</div>

<div id="toast" class="toast">Produit ajouté</div>

<div id="iosPrompt" class="ios-prompt">
  <div style="text-align:center;">
      Installez l'app <b>Become</b> sur votre iPhone : <br>
      cliquez sur <i class="fa-solid fa-share-from-square" style="color:#007AFF"></i> puis sur 
      <b>"Sur l'écran d'accueil"</b>.
  </div>
</div>

<script type="module">
import { auth, db } from "./js/firebase.config.js";
import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { 
  collection, query, where, orderBy, limit, getCountFromServer, 
  getDocs, doc, getDoc 
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

/* ================= ÉTAT GLOBAL ================= */
let CURRENT_USER = null;
let CART_KEY = "cart_guest";

const showToast = (msg) => {
  const t = document.getElementById("toast");
  t.textContent = msg;
  t.style.opacity = "1";
  setTimeout(() => t.style.opacity = "0", 2000);
};

/* ================= AUTH & SALUTATION ================= */
onAuthStateChanged(auth, async (user) => {
  const greeting = document.getElementById("userGreeting");
  if (user) {
    CURRENT_USER = user;
    CART_KEY = `cart_${user.uid}`;
    greeting.onclick = () => location.href = 'settings.html';
    const snap = await getDoc(doc(db, "users", user.uid));
    const name = snap.exists() ? (snap.data().firstName || "User") : "User";
    greeting.textContent = `Hello, ${name.split(' ')[0]}`;
  } else {
    greeting.textContent = "Log in";
    greeting.onclick = () => location.href = 'user.html';
  }
  updateCartIcon();
});

/* ================= PRODUITS (AVEC MÉLANGE ALÉATOIRE) ================= */
const grid = document.getElementById("grid");
const pageInfo = document.getElementById("pageInfo");
const PER_PAGE = 20; // Augmenté légèrement pour un meilleur effet de mélange
let currentPage = 1;

// Fonction de mélange aléatoire (Fisher-Yates)
function shuffleArray(array) {
  for (let i = array.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [array[i], array[j]] = [array[j], array[i]];
  }
  return array;
}

async function loadProducts() {
  grid.innerHTML = "";
  
  // 1. Récupération des produits actifs
  let q = query(
    collection(db, "products"), 
    where("active", "==", true), 
    limit(40) // On en prend un peu plus pour pouvoir bien les mélanger
  );
  
  const snap = await getDocs(q);
  if (snap.empty) return;

  // 2. Conversion du snapshot en tableau pour le mélanger
  let productsList = [];
  snap.forEach(doc => {
    productsList.push({ id: doc.id, ...doc.data() });
  });

  // 3. Mélange de l'ordre
  shuffleArray(productsList);

  // 4. Affichage
  productsList.forEach(p => {
    const card = document.createElement("article");
    card.className = "card";
    card.style.opacity = p.stock > 0 ? "1" : "0.5";
    card.innerHTML = `
      <img src="${p.imageUrl}" loading="lazy">
      <div class="card-body">
        <h3 class="title">${p.title}</h3>
        <div class="price">${p.price.toLocaleString('en-US')} USD</div>
      </div>`;
    card.onclick = () => location.href = `product.html?id=${p.id}`;
    grid.appendChild(card);
  });
  
  pageInfo.textContent = `MODE ALÉATOIRE`;
}

// On simplifie la pagination car le mélange aléatoire rend le "Suivant/Précédent" classique illogique
document.getElementById("next").onclick = () => loadProducts();
document.getElementById("prev").onclick = () => loadProducts();

loadProducts();

/* ================= PANIER LOGIQUE ================= */
const updateCartIcon = () => {
  const cart = JSON.parse(localStorage.getItem(CART_KEY) || "[]");
  const count = cart.reduce((s, i) => s + (parseInt(i.qty) || 0), 0);
  const badge = document.getElementById("cartCount");
  badge.style.display = count > 0 ? "block" : "none";
  badge.textContent = count;
};

document.getElementById("cartBtn").onclick = () => location.href = "panier.html";
document.getElementById("searchBtn").onclick = () => location.href = "search.html";

/* ================= INSTALL PWA (ANDROID) ================= */
let deferredPrompt;
window.addEventListener("beforeinstallprompt", (e) => {
  e.preventDefault();
  deferredPrompt = e;
  if(window.innerWidth < 768) {
     document.getElementById("installBtn").style.display = "block";
  }
});

document.getElementById("installBtn").onclick = async () => {
  if (deferredPrompt) {
    deferredPrompt.prompt();
    deferredPrompt = null;
    document.getElementById("installBtn").style.display = "none";
  }
};

/* ================= DÉTECTION iOS SPECIFIQUE ================= */
const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
const isStandalone = window.matchMedia('(display-mode: standalone)').matches;

if (isIOS && !isStandalone) {
    const prompt = document.getElementById("iosPrompt");
    setTimeout(() => { prompt.style.display = "block"; }, 3000);
    window.addEventListener('scroll', () => { prompt.style.display = "none"; }, { once: true });
}
</script>
</body>
</html>
